import os

from dotenv import load_dotenv
from google import genai
from google.genai import types
from supabase import create_client, Client
load_dotenv()

url: str = os.environ.get("SUPABASE_URL")
key: str = os.environ.get("SUPABASE_KEY")
supabase: Client = create_client(url, key)
embedding_ai = genai.Client(api_key=os.environ.get("EMBEDDING_API_KEY"))
reccommend_ai = genai.Client(api_key=os.environ.get("RECCOMMEND_API_KEY"))

def create_embedding(input):
    embedding_response = embedding_ai.models.embed_content(
            model="text-embedding-004",
            contents=input)
    embedding_vector = embedding_response.embeddings[0].values
    return embedding_vector

def find_nearest_match(embedding_vector):
    response = supabase.rpc("match_movies", {
        "query_embedding": embedding_vector,
        "match_threshold": 0.3,
        "match_count": 4
    }).execute()
    # print(response.data)
    # match_list = []
    # for item in response.data:
    #     match_list.append(item['content'])
    # print("Match List:", match_list)
    print(response.data)
    return response.data

def recommend_movies(preferences, context):
    response = reccommend_ai.models.generate_content(
        model="gemini-2.5-flash",
        config=types.GenerateContentConfig(
            system_instruction="You are an enthusiastic movie expert who loves recommending movies to people. You will be given two pieces of information - some context about movies and user query. Your main job is to formulate a short answer using the provided context and query. The answer should start with the movie and year followed by the description.  Use the following format: Movie Title: Year | Rating | Duration | Genre(s) \\n Description: Brief description of the movie plot.. If you are unsure and cannot find the answer in the context, say, 'Sorry, I don't know the answer.' Please do not make up the answer. Always speak as if you were chatting to a friend.",            temperature=0.65,
        ),
        contents=f"User Preferences: {preferences} Context: {context}"
    )
    return response.text

def get_movie_recommendation(user_preferences):
    embedding_vector = create_embedding(user_preferences)
    nearest_match = find_nearest_match(embedding_vector)
    recommendation = recommend_movies(user_preferences, nearest_match)
    return recommendation



# new_movie = get_movie_recommendation("My favorite movie is spiderman because I love superheroes and action-packed scenes. I want watch a movie that was released after 2000. I want to watch something serious")
# print("Movie Recommendation:", new_movie)
# embedding_vector =  [-0.0056823064, -0.04056116, -0.03571618, -0.005314157, 0.024309868, 0.06528322, 0.033220913, 0.048780136, 0.018892981, 0.024015022, 0.004226667, 0.002413809, 0.12708601, -0.011067199, -0.012634342, -0.04027647, -0.009042098, 0.024211604, -0.061779793, -0.015375874, -0.012123955, -0.015266669, 0.0047983294, -0.05690485, -0.02157858, 0.009109159, -0.059506256, -0.018224305, 0.043018993, 0.00025752926, 0.011154743, 0.047296315, 0.03224199, 0.03525947, -0.007562703, -0.08122068, -0.04393242, 0.016660031, 0.018828055, -0.046889722, -0.008527986, 0.00271525, -0.042559493, 0.05956867, -0.018301535, -0.01203615, 0.0005457019, -0.010450889, -0.0480488, 0.05733767, 0.036383525, 0.0035503, -0.091535755, -0.024311865, -0.0027377058, -0.06443606, -0.02250457, -0.030170383, -0.0014258538, 0.0053986735, -0.040509023, -0.043508105, 0.012900977, 0.05899353, 0.02157615, 0.009074205, -0.073544145, 0.008475869, -0.0041826284, 0.09012071, -0.016475856, 0.03175874, -0.032031413, 0.04392077, 0.009741564, 0.012769536, 0.027266959, 0.017095406, 0.017804328, 0.018724991, 0.040735256, -0.014945932, 0.08702428, 0.019233292, 0.022344816, -0.008547636, 0.0069959196, 0.019488344, 0.046894416, -0.014178735, 0.035239406, 0.03763591, -0.050986085, 0.051540848, 0.04016253, -0.0067047207, -0.01831828, -0.10021173, 0.07280401, -0.0105102, 0.0014874054, 0.010205045, -0.012884813, -0.03474741, 0.021930266, 0.050965216, 0.02485889, 0.0042548045, 0.013354502, 0.00060475146, 0.01216122, -0.007167261, 0.009835112, -0.010401748, -0.04522002, 0.046475552, 0.06513217, 0.07819389, 0.009463241, -0.009697051, 0.05919749, 0.0363588, -0.004471608, 0.055086285, 0.040771708, -0.0075166463, 0.0016602052, -0.0017078044, 0.011085941, -0.063669205, 0.016450446, -0.057449438, -0.034817196, 0.047111493, -0.021595277, -0.01972427, 0.038804937, -0.047259606, -0.022153793, -0.093187, 0.04141371, -0.0017244383, -0.012000673, 0.030538978, 0.006526253, -0.02249011, 0.024615396, 0.038002122, -0.121141285, -0.0015235593, -0.019713111, -0.057645984, 0.049099013, 0.024054902, -0.050760925, -0.03919395, -0.018733315, -0.023290846, 0.010477894, -0.02740623, 0.08071996, 0.046588212, -0.023564365, 0.002648773, -0.036599685, 0.02227102, -0.040924016, -0.048198808, -0.025945121, 0.026281094, -0.041430358, 0.007390572, -0.018607875, -0.13899793, -0.024275256, -0.023928989, -0.004989175, 0.015962707, -0.06615219, -0.016881771, -0.0268545, 0.084254146, -0.0069581857, 0.05370767, 0.007044378, 0.014120408, -0.028233841, 0.06964192, 0.032378603, 0.022764722, -0.009206584, -0.025401898, -0.020744115, -0.0148326345, -0.020518698, -0.024529563, -0.02322439, -0.0035361545, 0.028097495, -0.051648956, 0.014326411, -0.004688315, 0.030592388, -0.018661099, -0.00041849617, 0.0025001592, -0.0356415, -0.038881086, 0.016482586, -0.022793652, -0.02776364, 0.022774579, 0.006297665, -0.004241306, -0.046659928, 0.022018258, 0.03680133, -0.0006662624, 0.09593817, 0.016262323, -0.009274365, 0.003912435, 0.036368836, 0.024801072, -0.048875034, 0.023152774, -0.037837677, -0.031982057, -0.101376615, -0.038120434, -0.009037751, 0.039980777, 0.025633847, -0.0014428364, -0.07041856, -0.011136334, -0.04429427, 0.03397193, -0.0016004428, -0.016999278, -0.031439334, -0.06762439, 0.011348447, -0.013752329, -0.059275076, 0.002366318, 0.05844735, 0.07641025, 0.041647956, -0.007248743, 0.07881276, -0.0034005484, 0.021534735, -0.0058735474, -0.055881966, 0.009614736, 0.018973723, -0.0017737374, -0.05236929, -0.030350018, 0.0565569, -0.016456435, -0.040153697, -0.075018175, -0.0346069, -0.06731898, -0.062316608, 0.016307518, -0.027685994, -0.020146772, 0.039617345, -0.046833824, -0.04055152, -0.019327017, -0.119075544, -0.03243265, -0.03319764, 0.017683811, -0.044273876, -0.020148376, 0.0984182, -0.02803107, 0.023390245, -0.050864946, 0.04028474, -0.010659727, -0.05982097, -0.036976214, 0.031019103, 0.009946602, 0.04604602, -0.020069273, 0.0029681034, -0.0290416, 0.019332396, 0.034008138, 0.055558775, 0.009609774, 0.03239328, -0.025738003, -0.033692032, 0.020336227, -0.028727904, 0.012344822, 0.013763171, 0.045918617, -0.047077782, 0.04992552, 0.031205574, 0.016807357, 0.0038024338, -0.0047582546, -0.020588612, -0.033536192, -0.030481694, -0.046089977, -0.06774808, -0.02788986, -0.0019263912, -3.5569377e-05, 0.036169417, 0.06115279, 0.0019237727, 0.032854155, 0.022718893, -0.012744861, -0.012175125, 0.06267567, 0.043415207, -0.039350938, 0.023055239, 0.021176139, 0.022544237, -0.037670933, 0.027812365, 0.039585646, -0.077954024, 0.035436, 0.017268954, 0.06597174, -0.024486005, 0.023945272, 0.07616022, -0.02793777, 0.0083450135, -0.025425423, -0.0076453574, -0.020308884, 0.027452309, -0.027890299, -0.014665274, 0.024012886, 0.050320122, -0.02682856, -0.022419147, -0.009974223, 0.049449652, 0.05298793, 0.013368937, -0.00080672157, 0.008535464, -0.006185868, 0.025532052, 0.0075185713, 0.009140156, -0.041395728, 0.030484911, 0.05844885, -0.03253741, 0.011988992, 0.016534118, 8.765753e-05, -0.016569864, -0.0036398054, 0.013764117, -0.019640116, -0.010924454, 0.02859368, 0.03617376, -0.07279888, -0.039584555, -0.053814497, -0.0368706, 0.026645707, -0.028080935, 0.014419683, -0.08494622, 0.027142642, 0.00445102, 0.008397442, -0.0027364285, 0.03384684, -0.006911509, 0.0074988813, -0.026657287, 0.04871976, 0.003622222, 0.03861958, -0.05451168, -0.03900431, 0.0171705, 0.034148823, 0.06651708, -0.023942051, -0.008033948, -0.013699683, 0.03693475, -0.0006377459, 0.0059504523, -0.026435914, -0.016005859, -0.008322675, -0.06873274, 0.050516106, -0.04127481, 0.03361628, -0.02817175, -0.011211433, 0.024533542, 0.016630964, -0.053304464, 0.059057325, 0.013703683, -0.03839925, -0.04105024, -0.03837337, -0.039399963, 0.0003213161, -0.0033730785, 0.026314368, 0.06488253, -0.02312194, -0.0050393175, -0.056838777, 0.007338302, 0.011168403, 0.042644307, -0.0002708178, -0.022791047, -0.0024556995, 0.0033220283, -0.00047840798, 0.025107166, 0.009421182, 0.0042457255, 0.069191426, 0.015960766, 0.007068227, -0.019039424, -0.018526036, 0.05413511, -0.008850472, 0.032276012, 0.06593178, -0.03902636, -0.0070674843, -0.023190798, -0.01348679, 0.0030256296, 0.076404475, 0.008884103, -0.011732392, 0.04393016, 0.0019516713, -0.028652716, -0.0015319497, 0.04535657, 0.0108114425, 0.047642868, 0.034390233, -0.014018538, 0.018708754, 0.05406359, -0.03317922, -0.0038976755, -0.049013685, -0.031114265, 0.013540988, -0.016275225, 0.0148609355, -0.03928034, -0.022073423, 0.008625235, 0.0060583055, -0.03222666, -0.02659414, -0.021884426, -0.06526465, 0.019208362, -0.03498402, -0.00895295, 0.018659756, -0.049430545, 0.0068364306, -0.006600305, -0.029631665, 0.040316183, -0.040420406, 0.0028749066, -0.02161462, 0.005941838, 0.0004724781, -0.033380143, -0.03281133, -0.034723718, 0.006999047, -0.03963497, -0.009316224, 0.0218579, 0.028082898, 0.035250742, 0.021081584, 0.10876009, -0.009978863, -0.034758642, -0.00032102573, -0.0133002475, 0.0040529594, -0.05345719, 0.05255651, -0.017284432, -0.06715218, 0.008367984, -0.010520702, -0.018139865, 0.011934852, 0.02561739, -0.046516467, 0.028060721, -0.020090468, -0.038653485, 0.026769698, 0.028068556, 0.036585137, 0.046165857, 0.06409019, 0.03943618, -0.008171109, 0.029830027, 0.032051064, -0.006117949, 0.036515877, -0.012237294, 0.02268221, 0.020581597, -0.030529154, 0.002326185, 0.028073857, 0.00029106843, 0.0635267, 0.0014041103, -0.03955975, -0.019521568, -0.0051930584, -0.055077538, 0.012102734, -0.032844517, -0.034434292, -0.0071543953, -0.010595281, 0.022999078, -0.014418235, 0.0631729, 0.022226755, -0.028035274, 0.003224816, -0.031703226, 0.02024935, -0.047800347, 0.0025927455, 0.035126906, 0.0409649, 0.051773533, -0.012813865, -0.029998295, 0.03964797, -0.018566672, 0.006956045, 0.03625805, 0.0044818916, -0.044250265, 0.032716364, -0.0028911736, -0.013485624, -0.0005340038, -0.020444945, -0.018465068, -0.05101436, 0.08185712, 0.03233752, 0.006895217, -0.015253145, 0.0126458425, -0.0071006394, -0.025916886, -0.015763296, -0.0063277157, 0.10842225, -0.033788513, 0.020122144, 0.04557078, 0.045826726, -0.031896964, 0.015240975, -0.027815858, -0.016357964, 0.007682191, -0.03867096, -0.009448084, -0.024867667, -0.02208038, -0.011499176, -0.06627028, -0.028732272, -0.043339904, 0.006850869, -0.012030365, 0.0162943, 0.004088688, -0.024935396, -0.0074106604, -0.058674417, 0.018683907, -0.030940982, -0.013693371, 0.040433906, 0.027596746, -0.007672598, 0.0045776507, -0.008533896, -0.00018170991, 0.019864164, 0.026437, -0.07073729, -0.017383564, -0.0008308503, -0.030740354, -0.011435683, -0.060018703, -0.04101596, 0.038880263, -0.02269949, 0.06941611, -0.014626384, -0.08161408, 0.005089823, -0.009871264, 0.014061799, 0.038551454, 0.005454243, -0.025592988, -0.0014810791, -0.06334705, 0.033896808, -0.049037673, 0.0030659633, -0.016678998, 0.015989017, 0.02310501, 0.02972031, 0.040595148, -0.0063412907, -0.0011515332, 0.0034186079, -0.061861467, 0.03701555, 0.03389757, -0.017311068, 0.006448467, 0.024442688, -0.031331733, 0.01601948, 0.031767394, 0.0016207652, -0.02208556, 0.027267547, 0.023034872, 0.03261613, -0.044373114, -0.0057546715, -0.004972061, -0.083341144, 0.041264717, -0.03666522, -0.012068243, -0.018460482, -0.05333429, 0.030621756, -0.009316367, 0.012723772, -0.021693882, -0.06767575, -0.019966468, -0.0061737155, -0.0068378304, 0.045149516, -0.0068980865, 0.030291105, -0.08292129, 0.0636763, -0.004861158, -0.051536735, -0.00545124, -0.0018784623, 0.010305679, 0.00040264314, 0.0565522, -0.019363914, -0.001226741, -0.0073228516, -0.016197653, 0.031812042, 0.04348587, -0.055580832, 0.026050245, 0.047290605, -0.013616422, -0.00282154, -0.008722516, -0.028429596, -0.0046981066, -0.016829092, 0.002975318, -0.016010543, -0.0115124835, -0.043115597, -0.058397118, 0.004583958, 0.015839014, 0.00026074622, 0.045692928, 0.06317082, -0.051057216, 0.0022810197, -0.027779894, 0.009480706, -0.017183559, -0.039058838, 0.023804221, 0.07867788, 0.034863297, -0.002490428, 0.0047704717, -0.03098661, -0.010078422, 0.047800682, 0.0033929264, -0.023144446, -0.063953415, -0.03226583, -0.06582311, 0.041639246, -0.039571095, -0.030393383, 0.0037308016, 0.0013212664, -0.012346131, 0.021865472, 0.07912625, 0.012593908, -0.061818097, 0.067358166, 0.039384782, -0.019681301, -0.0055303234, 2.1188276e-05, 0.044393927, 0.011479887]
# nearest_match = find_nearest_match(embedding_vector)
# print("Nearest Match:", nearest_match)
# context = '\n\nTop Gun: Maverick: 2022 | PG-13 | 2h 10m | 8.3 rating\nThe action drama \'Top Gun: Maverick\' is about Pete "Maverick" Mitchell, a top naval aviator who served in the Navy for over three decades and is now a test pilot. He is determined to keep pushing the limits of flying and avoid promotions that would take him away from the cockpit. Maverick is currently training a group of graduates for a unique mission but must also confront his past and fears. Ultimately, the mission will require those who choose to fly it to make the ultimate sacrifice. Joseph Kosinski directed Top Gun: Maverick, which stars Tom Cruise, Jennifer Connelly, and Miles Teller.'
# user_preferences = "My favorite movie is spiderman because I love superheroes and action-packed scenes. I want watch a movie that was released after 2000. I want to watch something serious"
# recommendation = reccommend_movies(user_preferences, context)
# print("Movie Recommendation:", recommendation)



# response = client.models.generate_content(
#     model="gemini-2.5-flash",
#     contents="How does AI work?"
# )
# print(response.text)